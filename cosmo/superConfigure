#! /bin/sh 
set -eux

COSMO_LIBDIR=$(realpath "../../cosmopolitan/")
HEADER_PATHS=$(realpath "./header_stubs")
PREFIX=$(realpath "../../blead-cosmo")

if [ ! -f $COSMO_LIBDIR/cosmopolitan.h ]; then
    echo "<<<SUPERCONFIGURE>>> cosmopolitan.h does not exist in $COSMO_LIBDIR!!!!"
    exit 1
fi

echo "<<<SUPERCONFIGURE>>> cosmopolitan.h exists in $COSMO_LIBDIR, assuming other files exist as well"

cd ../

echo "<<<SUPERCONFIGURE>>> Running Configure"

sh Configure \
    -Dprefix="$PREFIX" \
    -Dusedevel \
    -Duserelocatableinc \
    -Uused1 \
    -Dccflags="-static -nostdlib -nostdinc -fno-pie -no-pie -mno-red-zone -fno-omit-frame-pointer -pg -mnop-mcount -mno-tls-direct-seg-refs -I$HEADER_PATHS -include $COSMO_LIBDIR/cosmopolitan.h" \
    -Dldflags="-static -nostdlib -nostdinc -fno-pie -mno-red-zone -include $COSMO_LIBDIR/cosmopolitan.h -Wl,--gc-sections -fuse-ld=bfd -Wl,-T,$COSMO_LIBDIR/ape.lds -include $COSMO_LIBDIR/cosmopolitan.h $COSMO_LIBDIR/crt.o $COSMO_LIBDIR/ape.o $COSMO_LIBDIR/cosmopolitan.a"
