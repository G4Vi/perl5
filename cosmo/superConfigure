#! /bin/sh
#
# cosmo/superConfigure - Ease configuring perl with the cosmopolitan
# libc for producing Actually Portable Perl.
#
# Run this from the root of perl repo, see README.cosmo. This script
# assumes the cosmopolitan repo is at the same level as the perl5 repo;
# set COSMO_REPO to override that path. i.e
# COSMO_REPO="/path/to/cosmopolitan" cosmo/superConfigure
# Arguments passed to this script will be directly passed on to
# Configure and should override the ones' provided here if needed.

set -eux

COSMO_REPO=$(realpath ${COSMO_REPO:="../cosmopolitan"});
COSMO_MODE=${COSMO_MODE:=''};
COSMO_APE_LOADER=${COSMO_APE_LOADER:='ape-no-modify-self.o'};
PREFIX='/zip'

if [ ! -d $COSMO_REPO ]; then
    echo "<<<SUPERCONFIGURE>>> cosmo repo not found"
    exit 1
fi
echo "<<<SUPERCONFIGURE>>> cosmo repo at $COSMO_REPO, assuming other files exist as well"

if [ "$COSMO_APE_LOADER" != 'ape-no-modify-self.o' -a "$COSMO_APE_LOADER" != 'ape.o' ]; then
    echo "<<<SUPERCONFIGURE>>> unknown ape loader $COSMO_APE_LOADER"
    exit 1
fi

echo "<<<SUPERCONFIGURE>>> Building cosmo, COSMO_MODE=$COSMO_MODE COSMO_APE_LOADER=$COSMO_APE_LOADER"
make -C "$COSMO_REPO" -j4 "MODE=$COSMO_MODE" "o/$COSMO_MODE/cosmopolitan.a"
make -C "$COSMO_REPO" -j4 "MODE=$COSMO_MODE" "o/$COSMO_MODE/libc/crt/crt.o"
make -C "$COSMO_REPO" -j4 "MODE=$COSMO_MODE" "o/$COSMO_MODE/ape/public/ape.lds"
make -C "$COSMO_REPO" -j4 "MODE=$COSMO_MODE" "o/$COSMO_MODE/ape/$COSMO_APE_LOADER"

echo "<<<SUPERCONFIGURE>>> Running Configure"
COSMO_REPO="$COSMO_REPO" COSMO_MODE="$COSMO_MODE" COSMO_APE_LOADER="$COSMO_APE_LOADER" sh Configure \
    -Dprefix="$PREFIX" \
    -Dusedevel \
    -Uversiononly \
    -Doptimize="-Os" \
    -Dmyhostname="cosmo" \
    -Dmydomain="invalid" \
    -Dcf_by="cosmo" \
    -DDEBUGGING \
    "$@"
